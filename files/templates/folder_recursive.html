{% load static %}
{% load custom_filters %}

{% for folder in folders %}
  <div style="margin-left:1em; display: flex; align-items: center; gap: 0.7em; margin-bottom: 0.7em;">
    <span style="flex:1; min-width:0; overflow-wrap:anywhere; display: flex; align-items: center;">
      <span onclick="toggleFolder('{{ folder.id }}')" style="cursor:pointer; display: flex; align-items: center; gap: 0.4em; width:100%;">
        <span style="font-size:0.98em; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 160px;">{{ folder.name }}</span>
        <span style="color:#888; font-size:0.95em; margin-left:0.5em;">{{ folder.allowed_type|upper }}</span>
      </span>
    </span>
    <div style="display: flex; flex-direction: column; gap: 0.3em; align-items: flex-end; min-width: 120px;">
      <button data-rename-folder="{{ folder.id }}" class="btn btn-secondary btn-sm" style="font-size:0.97em; padding:0.2em 0.7em;">Rename</button>
      <button data-delete-folder="{{ folder.id }}" class="btn btn-danger btn-sm" style="font-size:0.97em; padding:0.2em 0.7em;">Delete</button>
      <a href="{% url 'download_folder' folder.id %}" style="font-size:0.97em;">Download</a>
    </div>

    <!-- Note: id uses "folder-<id>" -->
    <ul id="folder-{{ folder.id }}"
        style="display:none; list-style:none; margin-left:2.2em; padding: 1.1em 1.2em 1.1em 1.2em; background: #f7fafd; border: 1.5px solid #e0e6ed; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.03); min-width: 270px; max-width: 420px;">
      <li style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.1em; gap: 0.7em;">
        <span style="font-size:0.98em; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 160px;">{{ folder.name }}</span>
        <span style="color:#888; font-size:0.95em; margin-left:0.5em;">{{ folder.allowed_type|upper }}</span>
        <span style="display: flex; flex-direction: row; gap: 0.7em; align-items: center;">
          <button data-rename-folder="{{ folder.id }}" class="btn btn-secondary btn-sm" style="font-size:0.97em; padding:0.2em 0.7em;">Rename</button>
          <button data-delete-folder="{{ folder.id }}" class="btn btn-danger btn-sm" style="font-size:0.97em; padding:0.2em 0.7em;">Delete</button>
          <a href="{% url 'download_folder' folder.id %}" style="font-size:0.97em;">Download</a>
        </span>
      </li>

      {% if folder.files.all %}
        <li style="margin-bottom:0.5em;">
          <input type="checkbox" class="select-all-files" data-folder-id="{{ folder.id }}"> <strong>Select All</strong>
          <button class="btn btn-danger btn-sm delete-selected-btn" data-folder-id="{{ folder.id }}" style="margin-left:1em; font-size:0.95em; padding:0.2em 0.7em;">Delete Selected</button>
        </li>
      {% endif %}
      {% for file in folder.files.all %}
        <li draggable="true"
            data-file-id="{{ file.id }}"
            ondragstart="onDragStart(event)"
            style="margin-bottom:1.1em; display: flex; align-items: center; gap: 0.7em; border-radius: 5px; transition: background 0.15s; min-height: 2.2em;">
          <input type="checkbox" class="file-checkbox" data-file-id="{{ file.id }}" data-folder-id="{{ folder.id }}">
          <span style="flex:1; overflow-wrap: anywhere; font-size:0.97em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 160px; display:inline-block;">{{ file.file.name|basename }}
            {% if file.config_added %}
              <span style="color:red;font-weight:bold;">CONFIG ADDED!</span>
            {% endif %}
          </span>
          <span style="display: flex; flex-direction: row; gap: 0.7em; align-items: center; min-width: 180px;">
            <a href="{% url 'download_file' file.id %}" style="font-size:0.97em;">Download</a>
            <button data-delete-file="{{ file.id }}" class="btn btn-danger btn-sm" style="font-size:0.97em; padding:0.2em 0.7em;">Delete</button>
            <button data-copy-file="{{ file.id }}" class="btn btn-secondary btn-sm" style="font-size:0.97em; padding:0.2em 0.7em;">Copy</button>
            <button data-move-file="{{ file.id }}" class="btn btn-secondary btn-sm" style="font-size:0.97em; padding:0.2em 0.7em;">Move</button>
          </span>
        </li>
      {% endfor %}

      {# Recurse into subfolders #}
      {% include "folder_recursive.html" with folders=folder.subfolders.all %}
    </ul>
  </div>
{% endfor %}
